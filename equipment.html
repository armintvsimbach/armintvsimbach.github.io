<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipmentverwaltung - Tauchclub Simbach am Inn</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <div class="header-container">
    <div class="burger" onclick="toggleMenu()">☰</div>
    <h1>Tauchclub Simbach am Inn</h1>
  </div>
  <nav id="main-nav">
    <a href="index.html">Start</a>
    <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
    <a href="verleih.html">Verleih</a>
    <a href="equipment.html">Equipmentverwaltung</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h2>Equipmentverwaltung</h2>

  <div style="margin-bottom: 20px;">
    <button onclick="openAddEquipmentModal()">➕ Neues Equipment hinzufügen</button>
    <input type="text" id="search-equipment" placeholder="Suchen...">
  </div>

  <table id="equipment-table">
    <thead>
      <tr>
        <th>Bild</th>
        <th>Name</th>
        <th>Kategorie</th>
        <th>Beschreibung</th>
        <th>Größe</th>
        <th>Letzte Wartung</th>
        <th>Wartungsintervall</th>
        <th>Nächste Wartung</th>
        <th>Status</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="equipment-cards"></div>
</main>

<!-- Modal -->
<div class="modal" id="equipmentModal" style="display: none;">
  <div class="modal-content">
    <h2 id="modal-title">Equipment bearbeiten</h2>
    <form id="equipment-form">
      <table style="width: 100%;">
        <tr><td>Name:</td><td><input type="text" id="eq-name" required></td></tr>
        <tr><td>Bild wählen:</td><td><input type="file" id="eq-bildfile" accept="image/*"><img id="existing-image" style="display:none; width:100px; margin-top:10px;"></td></tr>
        <tr><td>Kategorie:</td><td><select id="eq-kategorie" required></select></td></tr>
        <tr><td>Beschreibung:</td><td><input type="text" id="eq-beschreibung"></td></tr>
        <tr><td>Größe:</td><td><input type="text" id="eq-groesse"></td></tr>
        <tr><td>Letzte Wartung:</td><td><input type="date" id="eq-letztewartung"></td></tr>
        <tr><td>Wartungsintervall (Monate):</td><td><input type="number" id="eq-wartungsintervall"></td></tr>
        <tr><td>Status:</td><td>
          <select id="eq-status" required>
            <option value="Aktiv">Aktiv</option>
            <option value="Inaktiv">Inaktiv</option>
            <option value="Eingelagert">Eingelagert</option>
            <option value="Verschrottet">Verschrottet</option>
            <option value="Wartung">Wartung</option>
            <option value="Schwund">Schwund</option>
          </select>
        </td></tr>
      </table>
      <input type="hidden" id="eq-id">
      <input type="hidden" id="eq-bild-base64">
      <button type="submit">Speichern</button>
      <button type="button" onclick="closeEquipmentModal()">Abbrechen</button>
    </form>
  </div>
</div>

<div id="user-info" style="text-align: center; padding: 10px;"></div>

<script src="shared.js"></script>
<script>
const apiEquipment = 'https://tcs-manager-backend.onrender.com/api/equipment';
const apiCategories = 'https://tcs-manager-backend.onrender.com/api/categories';

let equipmentData = [];
let categories = [];

function checkLoginAndLoad() {
  checkLogin();
  const user = getUserInfo();
  if (user) {
    document.getElementById('user-info').innerHTML = `
      Angemeldet als <strong>${user.username}</strong> (${user.role})
      <button onclick="logout()" style="margin-left: 10px;">Logout</button>
    `;
  }
  fetchEquipmentAndCategories();
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "login.html";
}

function toggleMenu() {
  document.getElementById('main-nav').classList.toggle('show');
}

function fetchEquipmentAndCategories() {
  Promise.all([
    fetch(apiEquipment, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(res => res.json()),
    fetch(apiCategories, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(res => res.json())
  ]).then(([equipment, cats]) => {
    equipmentData = equipment;
    categories = cats;
    renderEquipmentTable(equipment);
  });
}

function renderEquipmentTable(data) {
  const tbody = document.querySelector('#equipment-table tbody');
  const cardsContainer = document.querySelector('.equipment-cards');
  tbody.innerHTML = '';
  cardsContainer.innerHTML = '';

  data.forEach(eq => {
    const nextMaintenance = calculateNextMaintenance(eq.letzte_wartung, eq.wartungsintervall);
    const imgSrc = eq.bild_base64 ? `data:image/jpeg;base64,${eq.bild_base64}` : 'placeholder.jpg';

    // Tabelle (Desktop)
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${imgSrc}" style="width:50px;height:auto;"></td>
      <td>${eq.name}</td>
      <td>${eq.kategorie}</td>
      <td>${eq.beschreibung}</td>
      <td>${eq.groesse}</td>
      <td>${eq.letzte_wartung ? eq.letzte_wartung.substring(0,10) : '-'}</td>
      <td>${eq.wartungsintervall || '-'}</td>
      <td>${nextMaintenance || '-'}</td>
      <td>${eq.status}</td>
      <td><button onclick='openEditEquipmentModal(${JSON.stringify(eq)})'>✏️</button></td>
    `;
    tbody.appendChild(tr);

    // Karten (Mobil)
    const card = document.createElement('div');
    card.className = "equipment-card";
    card.innerHTML = `
      <img src="${imgSrc}" style="width:100%;max-width:200px;margin-bottom:10px;">
      <h3>${eq.name}</h3>
      <p>Kategorie: ${eq.kategorie}</p>
      <p>Status: ${eq.status}</p>
      <p>Beschreibung: ${eq.beschreibung}</p>
      <p>Größe: ${eq.groesse}</p>
      <p>Wartung fällig: ${nextMaintenance || '-'}</p>
      <button onclick='openEditEquipmentModal(${JSON.stringify(eq)})'>Bearbeiten</button>
    `;
    cardsContainer.appendChild(card);
  });
}

function calculateNextMaintenance(last, interval) {
  if (!last || !interval) return null;
  const date = new Date(last);
  date.setMonth(date.getMonth() + parseInt(interval));
  return date.toISOString().substring(0,10);
}

function openAddEquipmentModal() {
  document.getElementById('modal-title').innerText = "Neues Equipment";
  document.getElementById('equipment-form').reset();
  document.getElementById('eq-id').value = '';
  document.getElementById('existing-image').style.display = 'none';
  populateCategorySelect();
  document.getElementById('equipmentModal').style.display = 'flex';
}

function openEditEquipmentModal(eq) {
  openAddEquipmentModal();
  document.getElementById('modal-title').innerText = "Equipment bearbeiten";
  document.getElementById('eq-id').value = eq.id;
  document.getElementById('eq-name').value = eq.name;
  document.getElementById('eq-beschreibung').value = eq.beschreibung;
  document.getElementById('eq-groesse').value = eq.groesse;
  document.getElementById('eq-letztewartung').value = eq.letzte_wartung ? eq.letzte_wartung.substring(0,10) : '';
  document.getElementById('eq-wartungsintervall').value = eq.wartungsintervall;
  document.getElementById('eq-status').value = eq.status;
  populateCategorySelect();
  document.getElementById('eq-kategorie').value = eq.kategorie;
  if (eq.bild_base64) {
    const img = document.getElementById('existing-image');
    img.src = `data:image/jpeg;base64,${eq.bild_base64}`;
    img.style.display = 'block';
  }
}

function closeEquipmentModal() {
  document.getElementById('equipmentModal').style.display = 'none';
}

function populateCategorySelect() {
  const select = document.getElementById('eq-kategorie');
  select.innerHTML = '';
  categories.forEach(cat => {
    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
  });
}

document.getElementById('search-equipment').addEventListener('input', () => {
  const query = document.getElementById('search-equipment').value.toLowerCase();
  const filtered = equipmentData.filter(eq =>
    Object.values(eq).some(val => val && val.toString().toLowerCase().includes(query))
  );
  renderEquipmentTable(filtered);
});

document.getElementById('equipment-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const eq = {
    name: document.getElementById('eq-name').value,
    kategorie: document.getElementById('eq-kategorie').value,
    beschreibung: document.getElementById('eq-beschreibung').value,
    groesse: document.getElementById('eq-groesse').value,
    letzte_wartung: document.getElementById('eq-letztewartung').value,
    wartungsintervall: document.getElementById('eq-wartungsintervall').value,
    status: document.getElementById('eq-status').value
  };
  const id = document.getElementById('eq-id').value;
  const method = id ? 'PUT' : 'POST';
  const url = id ? `${apiEquipment}/${id}` : apiEquipment;

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(eq)
  }).then(() => {
    closeEquipmentModal();
    fetchEquipmentAndCategories();
  });
});

document.addEventListener('DOMContentLoaded', checkLoginAndLoad);
</script>

</body>
</html>
