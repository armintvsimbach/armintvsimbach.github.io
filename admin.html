
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="header-container">
        <h1>TC Simbach</h1>
    </div>
    <div class="burger" onclick="toggleMenu()">☰</div>
    <nav id="main-nav">
        <a href="index.html">Start</a>
		<a href="verleih.html">Verleih</a>
        <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
        <a href="equipment.html">Equipmentverwaltung</a>
        <a href="admin.html">Admin</a>
    </nav>
</header>

<main>
    <h2>Admin Übersicht</h2>
    <div class="card-container">
        <div class="card" onclick="openUserDialog()">
            <h3>Benutzerverwaltung</h3>
            <p id="user-stats">Lade...</p>
        </div>
        <div class="card" onclick="openAuditDialog()">
            <h3>Verleihhistorie</h3>
            <p>Alle Aktionen im Überblick</p>
        </div>
    </div>
</main>

<div id="alert" class="alert"></div>

<!-- Benutzer Dialog -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('userModal')">X</span>
        <h3>Benutzerübersicht</h3>
        <button id="new-user-btn" onclick="createUser()">➕ Neuen Benutzer anlegen</button>
        <div class="table-wrapper"><table id="user-table"><thead><tr><th>Benutzername</th><th>Email</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead><tbody></tbody></table></div>
        <div class="user-cards"></div>
    </div>
</div>

<!-- Benutzer Bearbeiten / Erstellen Dialog -->
<div class="modal" id="editUserModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editUserModal')">X</span>
        <h3 id="editUserTitle">Benutzer bearbeiten</h3>
        <form id="edit-user-form">
            <input type="hidden" id="edit-user-id">
            <label>Benutzername:<input type="text" id="edit-username" required></label>
            <label>Email:<input type="email" id="edit-email" required></label>
            <label>Rolle:<select id="edit-role"><option>benutzer</option><option>ausbilder</option><option>administrator</option></select></label>
            <label>Status:<select id="edit-status"><option value="true">Aktiv</option><option value="false">Gesperrt</option></select></label>
            <label id="password-field" style="display:none;">Passwort:<input type="text" id="edit-password"></label>
            <button type="submit">Speichern</button>
        </form>
    </div>
</div>

<!-- Audit Log Dialog -->
<div class="modal" id="auditModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('auditModal')">X</span>
        <h3>Verleihhistorie (Audit Log)</h3>
        <label>Von <input type="date" id="audit-from"></label>
        <label>Bis <input type="date" id="audit-to"></label>
        <button onclick="loadAudit()">Filtern</button>
        <div class="table-wrapper"><table id="audit-table"><thead><tr><th>Benutzer</th><th>Equipment</th><th>Aktion</th><th>Zeitpunkt</th><th>Fällig</th><th>Rückgabe</th></tr></thead><tbody></tbody></table></div>
    </div>
</div>

<script src="shared.js"></script>
<script>
checkLogin();
const apiUsers = "https://tcs-manager-backend.onrender.com/api/users";
const apiAudit = "https://tcs-manager-backend.onrender.com/api/equipment-log";
const apiMembers = "https://tcs-manager-backend.onrender.com/api/members";
const apiEquipment = "https://tcs-manager-backend.onrender.com/api/equipment";

let members = [], equipment = [], currentUser = null;

document.addEventListener("DOMContentLoaded", () => {
    loadUserStats();
});

function toggleMenu() {
    document.getElementById('main-nav').classList.toggle('show');
}

function loadUserStats() {
    fetch(apiUsers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
    .then(r => r.json())
    .then(users => {
        let active = users.filter(u => u.active).length;
        let inactive = users.length - active;
        document.getElementById('user-stats').innerText = `${active} aktiv / ${inactive} gesperrt`;
    });
}

function showAlert(msg) {
    const alert = document.getElementById('alert');
    alert.innerText = msg;
    alert.style.display = 'block';
    setTimeout(() => alert.style.display = 'none', 3000);
}

function openUserDialog() {
    document.getElementById('userModal').style.display = 'flex';
    loadUsers();
}

function openAuditDialog() {
    document.getElementById('auditModal').style.display = 'flex';
    loadAudit();
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }
});

function loadUsers() {
    fetch(apiUsers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
    .then(r => r.json())
    .then(users => {
        const tbody = document.querySelector('#user-table tbody');
        const cardsContainer = document.querySelector('.user-cards');
        tbody.innerHTML = '';
        cardsContainer.innerHTML = '';

        let active = 0, blocked = 0;
        users.forEach(u => {
            if (u.active) active++; else blocked++;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.username}</td><td>${u.email}</td><td>${u.role}</td><td>${u.active ? "Aktiv" : "Gesperrt"}</td>
            <td><button onclick='editUser(${JSON.stringify(u)})'>Bearbeiten</button></td>`;
            tbody.appendChild(tr);

            const card = document.createElement('div');
            card.className = "user-card";
            card.innerHTML = `<h3>${u.username}</h3><p><strong>Email:</strong> ${u.email}</p><p><strong>Rolle:</strong> ${u.role}</p>
            <p><strong>Status:</strong> ${u.active ? "Aktiv" : "Gesperrt"}</p><button onclick='editUser(${JSON.stringify(u)})'>Bearbeiten</button>`;
            cardsContainer.appendChild(card);
        });

        document.getElementById('user-stats').innerText = `${active} aktiv / ${blocked} gesperrt`;
    });
}

function editUser(user) {
    currentUser = user;
    document.getElementById('editUserTitle').innerText = "Benutzer bearbeiten";
    document.getElementById('edit-user-id').value = user.id;
    document.getElementById('edit-username').value = user.username;
    document.getElementById('edit-email').value = user.email;
    document.getElementById('edit-role').value = user.role;
    document.getElementById('edit-status').value = user.active;
    document.getElementById('password-field').style.display = "none";
    document.getElementById('editUserModal').style.display = 'flex';
}

function createUser() {
    currentUser = null;
    document.getElementById('editUserTitle').innerText = "Neuen Benutzer anlegen";
    document.getElementById('edit-user-id').value = '';
    document.getElementById('edit-username').value = '';
    document.getElementById('edit-email').value = '';
    document.getElementById('edit-role').value = 'benutzer';
    document.getElementById('edit-status').value = 'true';
    document.getElementById('password-field').style.display = "block";
    document.getElementById('edit-password').value = '';
    document.getElementById('editUserModal').style.display = 'flex';
}

document.getElementById('edit-user-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-user-id').value;
    const user = {
        username: document.getElementById('edit-username').value,
        email: document.getElementById('edit-email').value,
        role: document.getElementById('edit-role').value,
        active: document.getElementById('edit-status').value === "true"
    };
    const password = document.getElementById('edit-password').value;

    if (!id && !password) return alert("Passwort für neuen Benutzer eingeben!");
    if (!id) user.password = password;

    fetch(apiUsers + (id ? "/" + id : ""), {
        method: id ? "PUT" : "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("token") },
        body: JSON.stringify(user)
    }).then(() => {
        closeModal('editUserModal');
        showAlert(id ? "Benutzer gespeichert." : "Neuer Benutzer angelegt.");
        loadUsers();
    });
});

function loadAudit() {
    const from = document.getElementById("audit-from").value;
    const to = document.getElementById("audit-to").value;
    let url = apiAudit;
    const params = [];
    if (from) params.push("from=" + from);
    if (to) params.push("to=" + to);
    if (params.length > 0) url += "?" + params.join("&");

    Promise.all([
        fetch(url, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json()),
        fetch(apiMembers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json()),
        fetch(apiEquipment, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json())
    ]).then(([logs, m, e]) => {
        members = m;
        equipment = e;

        logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const tbody = document.querySelector('#audit-table tbody');
        tbody.innerHTML = '';
        logs.forEach(log => {
            const member = members.find(m => m.id == log.user_id);
            const eq = equipment.find(eq => eq.id == log.equipment_id);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${member ? member.vorname + ' ' + member.name : log.user_id}</td>
            <td>${eq ? eq.name : log.equipment_id}</td>
            <td>${log.action}</td><td>${log.timestamp}</td>
            <td>${log.due_date || '-'}</td><td>${log.returned_date || '-'}</td>`;
            tbody.appendChild(tr);
        });
    });
}
</script>

</body>
</html>
