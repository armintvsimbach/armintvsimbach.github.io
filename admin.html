
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
.card-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 20px; }
.card { background: #f2f2f2; padding: 20px; border-radius: 10px; width: 300px; text-align: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
.card:hover { transform: translateY(-5px); background-color: #e9e9e9; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999; }
.modal-content { background: #fff; padding: 20px; border-radius: 10px; max-height: 90%; overflow-y: auto; position: relative; width: 95%; max-width: 800px; }
.close { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 20px; color: #888; }
.close:hover { color: #000; }
.alert { background-color: #4CAF50; color: white; padding: 10px; margin-top: 10px; border-radius: 5px; display: none; text-align: center; }
@media (max-width: 600px) {
    .card { width: 90%; }
}
</style>
</head>
<body>

<header>
    <div class="header-container">
        <h1>TC Simbach - Admin Dashboard</h1>
    </div>
    <nav id="main-nav">
        <a href="index.html">Start</a>
        <a href="verleih.html">Verleih</a>
        <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
        <a href="equipment.html">Equipmentverwaltung</a>
        <a href="admin.html">Admin</a>
    </nav>
</header>

<main>
    <h2>Admin Übersicht</h2>
    <div class="card-container">
        <div class="card" onclick="openUserDialog()">
            <h3>Benutzerverwaltung</h3>
            <p id="user-stats">Lade...</p>
        </div>
        <div class="card" onclick="openAuditDialog()">
            <h3>Verleihhistorie</h3>
            <p>Alle Aktionen im Überblick</p>
        </div>
    </div>
</main>

<div id="alert" class="alert"></div>

<!-- Benutzer Dialog -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('userModal')">X</span>
        <h3>Benutzerübersicht</h3>
        <table id="user-table"><thead><tr><th>Benutzername</th><th>Email</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead><tbody></tbody></table>
    </div>
</div>

<!-- Benutzer Bearbeiten Dialog -->
<div class="modal" id="editUserModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editUserModal')">X</span>
        <h3>Benutzer bearbeiten</h3>
        <form id="edit-user-form">
            <input type="hidden" id="edit-user-id">
            <label>Benutzername:<input type="text" id="edit-username" required></label>
            <label>Email:<input type="email" id="edit-email" required></label>
            <label>Rolle:<select id="edit-role"><option>benutzer</option><option>ausbilder</option><option>administrator</option></select></label>
            <label>Status:<select id="edit-status"><option value="true">Aktiv</option><option value="false">Gesperrt</option></select></label>
            <button type="submit">Speichern</button>
            <button type="button" onclick="resetPassword()">Passwort zurücksetzen</button>
        </form>
    </div>
</div>

<!-- Audit Log Dialog -->
<div class="modal" id="auditModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('auditModal')">X</span>
        <h3>Verleihhistorie (Audit Log)</h3>
        <label>Von <input type="date" id="audit-from"></label>
        <label>Bis <input type="date" id="audit-to"></label>
        <button onclick="loadAudit()">Filtern</button>
        <table id="audit-table"><thead><tr><th>Benutzer</th><th>Equipment</th><th>Aktion</th><th>Zeitpunkt</th><th>Fällig</th><th>Rückgabe</th></tr></thead><tbody></tbody></table>
    </div>
</div>

<script src="shared.js"></script>
<script>
checkLogin();
const apiUsers = "https://tcs-manager-backend.onrender.com/api/users";
const apiAudit = "https://tcs-manager-backend.onrender.com/api/equipment-log";
const apiMembers = "https://tcs-manager-backend.onrender.com/api/members";
const apiEquipment = "https://tcs-manager-backend.onrender.com/api/equipment";

let members = [], equipment = [], currentUser = null;

// Direkt beim Start Benutzerstatistik laden
document.addEventListener("DOMContentLoaded", () => {
    loadUserStats();
});

function loadUserStats() {
    fetch(apiUsers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
    .then(r => r.json())
    .then(users => {
        let active = users.filter(u => u.active).length;
        let inactive = users.length - active;
        document.getElementById('user-stats').innerText = `${active} aktiv / ${inactive} gesperrt`;
    });
}

function showAlert(msg) {
    const alert = document.getElementById('alert');
    alert.innerText = msg;
    alert.style.display = 'block';
    setTimeout(() => alert.style.display = 'none', 3000);
}

function openUserDialog() {
    document.getElementById('userModal').style.display = 'flex';
    loadUsers();
}

function openAuditDialog() {
    document.getElementById('auditModal').style.display = 'flex';
    loadAudit();
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }
});

function loadUsers() {
    fetch(apiUsers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
    .then(r => r.json())
    .then(users => {
        const tbody = document.querySelector('#user-table tbody');
        tbody.innerHTML = '';
        let active = 0, blocked = 0;
        users.forEach(u => {
            if (u.active) active++; else blocked++;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.username}</td><td>${u.email}</td><td>${u.role}</td><td>${u.active ? "Aktiv" : "Gesperrt"}</td>
            <td><button onclick='editUser(${JSON.stringify(u)})'>Bearbeiten</button></td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('user-stats').innerText = `${active} aktiv / ${blocked} gesperrt`;
    });
}

function editUser(user) {
    currentUser = user;
    document.getElementById('edit-user-id').value = user.id;
    document.getElementById('edit-username').value = user.username;
    document.getElementById('edit-email').value = user.email;
    document.getElementById('edit-role').value = user.role;
    document.getElementById('edit-status').value = user.active;
    document.getElementById('editUserModal').style.display = 'flex';
}

document.getElementById('edit-user-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-user-id').value;
    const user = {
        username: document.getElementById('edit-username').value,
        email: document.getElementById('edit-email').value,
        role: document.getElementById('edit-role').value,
        active: document.getElementById('edit-status').value === "true"
    };

    fetch(apiUsers + "/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("token") },
        body: JSON.stringify(user)
    }).then(() => {
        closeModal('editUserModal');
        showAlert("Benutzer gespeichert.");
        loadUsers();
    });
});

function resetPassword() {
    const id = document.getElementById('edit-user-id').value;
    const newPassword = prompt("Neues Passwort eingeben:");
    if (!newPassword) return;
    fetch("https://tcs-manager-backend.onrender.com/api/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + localStorage.getItem("token") },
        body: JSON.stringify({ id, password: newPassword })
    }).then(() => showAlert("Passwort wurde geändert."));
}

function loadAudit() {
    const from = document.getElementById("audit-from").value;
    const to = document.getElementById("audit-to").value;
    let url = apiAudit;
    const params = [];
    if (from) params.push("from=" + from);
    if (to) params.push("to=" + to);
    if (params.length > 0) url += "?" + params.join("&");

    Promise.all([
        fetch(url, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json()),
        fetch(apiMembers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json()),
        fetch(apiEquipment, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } }).then(r => r.json())
    ]).then(([logs, m, e]) => {
        members = m;
        equipment = e;

        logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const tbody = document.querySelector('#audit-table tbody');
        tbody.innerHTML = '';
        logs.forEach(log => {
            const member = members.find(m => m.id == log.user_id);
            const eq = equipment.find(eq => eq.id == log.equipment_id);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${member ? member.vorname + ' ' + member.name : log.user_id}</td>
            <td>${eq ? eq.name : log.equipment_id}</td>
            <td>${log.action}</td><td>${log.timestamp}</td>
            <td>${log.due_date || '-'}</td><td>${log.returned_date || '-'}</td>`;
            tbody.appendChild(tr);
        });
    });
}
</script>

</body>
</html>
