<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitgliederverwaltung - TCS Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="header-container">
        <div class="burger" onclick="toggleMenu()">☰</div>
        <h1>Vereinsverwaltung Tauchclub Simbach am Inn</h1>
    </div>

    <nav id="main-nav">
        <a href="index.html">Start</a>
        <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
        <a href="verleih.html">Verleih</a>
        <a href="equipment.html">Equipmentverwaltung</a>
        <a href="admin.html">Admin</a>
    </nav>
</header>

<main>
    <h2>Mitgliederverwaltung</h2>

    <button onclick="openAddMemberModal()">➕ Mitglied hinzufügen</button>
    <input type="text" id="search" placeholder="Mitglieder suchen..." onkeyup="filterMembers()">

    <table id="members-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Geburtsdatum</th>
                <th>Email</th>
                <th>Status</th>
                <th>TTU gültig</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            <!-- Mitglieder werden hier geladen -->
        </tbody>
    </table>
</main>

<!-- Mitglied bearbeiten / hinzufügen Modal -->
<div id="memberModal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">Mitglied hinzufügen</h3>
        <form id="member-form">
            <input type="hidden" id="m-id">
            
            <label>Name:</label>
            <input type="text" id="m-name" required><br><br>

            <label>Geburtsdatum:</label>
            <input type="date" id="m-birthdate" required><br><br>

            <label>Email:</label>
            <input type="email" id="m-email" required><br><br>

            <label>Status:</label>
            <select id="m-active">
                <option value="true">Aktiv</option>
                <option value="false">Inaktiv</option>
            </select><br><br>

            <label>TTU gültig:</label>
            <select id="m-ttu_valid">
                <option value="true">Ja</option>
                <option value="false">Nein</option>
            </select><br><br>

            <button type="submit">Speichern</button>
            <button type="button" onclick="closeMemberModal()">Abbrechen</button>
        </form>
    </div>
</div>

<div id="user-info" style="text-align: center; padding: 10px;"></div>

<script src="shared.js"></script>
<script>
// Benutzer prüfen + anzeigen
checkLogin();

const user = getUserInfo();
if (user) {
    document.getElementById('user-info').innerHTML = `
        Angemeldet als <strong>${user.username}</strong> (${user.role}) 
        <button onclick="logout()" style="margin-left: 10px;">Logout</button>
    `;
}

function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
}

// Burger-Menü
function toggleMenu() {
    document.getElementById('main-nav').classList.toggle('show');
}

// Mitglieder laden
function loadMembers() {
    fetch("https://tcs-manager-backend.onrender.com/api/members", {
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("token")
        }
    })
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector('#members-table tbody');
        tbody.innerHTML = '';

        data.forEach(member => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${member.name}</td>
                <td>${member.birthdate}</td>
                <td>${member.email}</td>
                <td>${member.active ? 'Aktiv' : 'Inaktiv'}</td>
                <td>${member.ttu_valid ? 'Ja' : 'Nein'}</td>
                <td>
                    <button onclick="editMember(${member.id})">Bearbeiten</button>
                    <button onclick="deleteMember(${member.id})">Löschen</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    });
}

// Mitglieder filtern
function filterMembers() {
    const input = document.getElementById('search').value.toLowerCase();
    const rows = document.querySelectorAll('#members-table tbody tr');

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? '' : 'none';
    });
}

// Modal öffnen für NEU
function openAddMemberModal() {
    document.getElementById('modal-title').innerText = "Mitglied hinzufügen";
    document.getElementById('member-form').reset();
    document.getElementById('m-id').value = '';
    document.getElementById('memberModal').style.display = 'flex';
}

// Modal öffnen für BEARBEITEN
function editMember(id) {
    fetch(`https://tcs-manager-backend.onrender.com/api/members/${id}`, {
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    })
    .then(res => res.json())
    .then(member => {
        document.getElementById('modal-title').innerText = "Mitglied bearbeiten";
        document.getElementById('m-id').value = member.id;
        document.getElementById('m-name').value = member.name;
        document.getElementById('m-birthdate').value = member.birthdate;
        document.getElementById('m-email').value = member.email;
        document.getElementById('m-active').value = member.active
