<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipmentverwaltung - Tauchclub Simbach am Inn</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <div class="header-container">
    <img src="logo-placeholder.png" alt="Vereinslogo" class="logo">
    <h1>Vereinsverwaltung Tauchclub Simbach am Inn</h1>
  </div>
  <nav>
    <a href="index.html">Start</a>
    <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
    <a href="verleih.html">Verleih</a>
    <a href="equipment.html">Equipmentverwaltung</a>
  </nav>
</header>

<main>
  <section id="equipment">
    <h2>Equipmentverwaltung</h2>

    <div style="margin-bottom: 20px;">
      <button onclick="openAddEquipmentModal()">‚ûï Neues Equipment hinzuf√ºgen</button>
      <button onclick="openCategoryModal()">üõ†Ô∏è Kategorien verwalten</button>
      <br><br>
      <input type="text" id="search-equipment" placeholder="Equipment suchen...">
      <select id="filter-category"></select>
      <select id="filter-status">
        <option value="">Alle Status</option>
        <option value="Verf√ºgbar">Verf√ºgbar</option>
        <option value="Ausgeliehen">Ausgeliehen</option>
        <option value="Gesperrt">Gesperrt</option>
        <option value="Eingelagert">Eingelagert</option>
        <option value="Verschrottet">Verschrottet</option>
      </select>
    </div>

    <table id="equipment-table">
      <thead>
        <tr>
          <th>Bild</th>
          <th>Name</th>
          <th>Kategorie</th>
          <th>Beschreibung</th>
          <th>Gr√∂√üe</th>
          <th>Letzte Wartung</th>
          <th>Wartungsintervall</th>
          <th>N√§chste Wartung</th>
          <th>Status</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Equipment-Modal -->
<div class="modal" id="equipmentModal">
  <div class="modal-content">
    <h2 id="modal-title">Neues Equipment</h2>
    <form id="equipment-form">
      <table style="width: 100%;">
        <tr><td><strong>Name:</strong></td><td><input type="text" id="eq-name" required></td></tr>
        <tr><td><strong>Bild w√§hlen:</strong></td>
          <td>
            <input type="file" id="eq-bildfile" accept="image/*" capture="environment">
            <img id="existing-image" style="display:none; width:100px; margin-top:10px;">
          </td>
        </tr>
        <tr><td><strong>Kategorie:</strong></td><td><select id="eq-kategorie" required></select></td></tr>
        <tr><td><strong>Beschreibung:</strong></td><td><input type="text" id="eq-beschreibung"></td></tr>
        <tr><td><strong>Gr√∂√üe:</strong></td><td><input type="text" id="eq-groesse"></td></tr>
        <tr><td><strong>Letzte Wartung:</strong></td><td><input type="date" id="eq-letztewartung"></td></tr>
        <tr><td><strong>Wartungsintervall:</strong></td><td><input type="number" id="eq-wartungsintervall"></td></tr>
        <tr><td><strong>Status:</strong></td>
          <td>
            <select id="eq-status" required>
              <option value="Verf√ºgbar">Verf√ºgbar</option>
              <option value="Ausgeliehen">Ausgeliehen</option>
              <option value="Gesperrt">Gesperrt</option>
              <option value="Eingelagert">Eingelagert</option>
              <option value="Verschrottet">Verschrottet</option>
            </select>
          </td>
        </tr>
      </table>
      <input type="hidden" id="eq-id">
      <input type="hidden" id="eq-bild-base64">
      <button type="submit">Speichern</button>
      <button type="button" onclick="closeEquipmentModal()" class="close-button">Abbrechen</button>
    </form>
  </div>
</div>

<script>
// const apiEquipment = 'http://localhost:3000/api/equipment';
// const apiCategories = 'http://localhost:3000/api/categories';
const apiEquipment = 'http://raspberrypi:3000/api/equipment';
const apiCategories = 'http://raspberrypi:3000/api/categories';
let equipmentData = [];
let categories = [];

function fetchEquipmentAndCategories() {
  Promise.all([
    fetch(apiEquipment).then(res => res.json()),
    fetch(apiCategories).then(res => res.json())
  ]).then(([equipment, cats]) => {
    equipmentData = equipment;
    categories = cats;
    renderEquipmentTable();
    populateCategoryFilters();
  });
}

function renderEquipmentTable(data = equipmentData) {
  const tbody = document.querySelector('#equipment-table tbody');
  tbody.innerHTML = '';
  data.forEach(eq => {
    const nextMaintenance = calculateNextMaintenance(eq.letzte_wartung, eq.wartungsintervall);
    const imgSrc = eq.bild_base64 ? `data:image/jpeg;base64,${eq.bild_base64}` : 'placeholder.jpg';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${imgSrc}" style="width:50px;height:auto;"></td>
      <td>${eq.name}</td>
      <td>${eq.kategorie}</td>
      <td>${eq.beschreibung}</td>
      <td>${eq.groesse}</td>
      <td>${eq.letzte_wartung ? eq.letzte_wartung.substring(0,10) : '-'}</td>
      <td>${eq.wartungsintervall || '-'}</td>
      <td>${nextMaintenance || '-'}</td>
      <td>${eq.status}</td>
      <td><button onclick='openEditEquipmentModal(${JSON.stringify(eq)})'>‚úèÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function applyFilters() {
  const query = document.getElementById('search-equipment').value.toLowerCase();
  const selectedCategory = document.getElementById('filter-category').value;
  const selectedStatus = document.getElementById('filter-status').value;

  const filtered = equipmentData.filter(eq => {
    const matchesSearch = eq.name.toLowerCase().includes(query) ||
                          (eq.beschreibung && eq.beschreibung.toLowerCase().includes(query)) ||
                          (eq.kategorie && eq.kategorie.toLowerCase().includes(query)) ||
                          (eq.status && eq.status.toLowerCase().includes(query));

    const matchesCategory = !selectedCategory || eq.kategorie === selectedCategory;
    const matchesStatus = !selectedStatus || eq.status === selectedStatus;

    return matchesSearch && matchesCategory && matchesStatus;
  });

  renderEquipmentTable(filtered);
}

function populateCategoryFilters() {
  const select = document.getElementById('filter-category');
  select.innerHTML = '<option value="">Alle Kategorien</option>';
  categories.forEach(cat => {
    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
  });
}

function populateCategorySelect() {
  const select = document.getElementById('eq-kategorie');
  select.innerHTML = '';
  categories.forEach(cat => {
    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
  });
}

function calculateNextMaintenance(last, interval) {
  if (!last || !interval) return null;
  const date = new Date(last);
  date.setMonth(date.getMonth() + parseInt(interval));
  return date.toISOString().substring(0,10);
}

function openAddEquipmentModal() {
  document.getElementById('modal-title').innerText = "Neues Equipment";
  document.getElementById('equipment-form').reset();
  document.getElementById('eq-id').value = '';
  document.getElementById('eq-bild-base64').value = '';
  document.getElementById('existing-image').style.display = 'none';
  populateCategorySelect();
  document.getElementById('equipmentModal').style.display = 'flex';
}

function openEditEquipmentModal(eq) {
  openAddEquipmentModal();
  document.getElementById('modal-title').innerText = "Equipment bearbeiten";
  document.getElementById('eq-id').value = eq.id;
  document.getElementById('eq-name').value = eq.name;
  document.getElementById('eq-beschreibung').value = eq.beschreibung;
  document.getElementById('eq-groesse').value = eq.groesse;
  document.getElementById('eq-letztewartung').value = eq.letzte_wartung ? eq.letzte_wartung.substring(0,10) : '';
  document.getElementById('eq-wartungsintervall').value = eq.wartungsintervall;
  document.getElementById('eq-status').value = eq.status;
  populateCategorySelect();
  document.getElementById('eq-kategorie').value = eq.kategorie;
  document.getElementById('eq-bild-base64').value = eq.bild_base64;
  if (eq.bild_base64) {
    const img = document.getElementById('existing-image');
    img.src = `data:image/jpeg;base64,${eq.bild_base64}`;
    img.style.display = 'block';
  }
}

function closeEquipmentModal() {
  document.getElementById('equipmentModal').style.display = 'none';
}

// Datei Upload und Preview
document.getElementById('eq-bildfile').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    document.getElementById('eq-bild-base64').value = base64;
    const img = document.getElementById('existing-image');
    img.src = `data:image/jpeg;base64,${base64}`;
    img.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

// Formular speichern
document.getElementById('equipment-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const eq = {
    name: document.getElementById('eq-name').value,
    bild_base64: document.getElementById('eq-bild-base64').value,
    kategorie: document.getElementById('eq-kategorie').value,
    beschreibung: document.getElementById('eq-beschreibung').value,
    groesse: document.getElementById('eq-groesse').value,
    letzte_wartung: document.getElementById('eq-letztewartung').value,
    wartungsintervall: document.getElementById('eq-wartungsintervall').value,
    status: document.getElementById('eq-status').value
  };
  const id = document.getElementById('eq-id').value;
  if (id) {
    fetch(`${apiEquipment}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(eq)
    }).then(() => {
      closeEquipmentModal();
      fetchEquipmentAndCategories();
    });
  } else {
    fetch(apiEquipment, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(eq)
    }).then(() => {
      closeEquipmentModal();
      fetchEquipmentAndCategories();
    });
  }
});

// Event-Listener f√ºr Filter und Suche
document.getElementById('search-equipment').addEventListener('input', applyFilters);
document.getElementById('filter-category').addEventListener('change', applyFilters);
document.getElementById('filter-status').addEventListener('change', applyFilters);

// Initiales Laden
fetchEquipmentAndCategories();
</script>

</body>
</html>
