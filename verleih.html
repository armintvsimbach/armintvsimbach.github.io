<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verleih - Tauchclub Simbach am Inn</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="header-container">
        <div class="burger" onclick="toggleMenu()">☰</div>
        <h1>Verleih - Tauchclub Simbach am Inn</h1>
    </div>

    <nav id="main-nav">
        <a href="index.html">Start</a>
        <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
        <a href="verleih.html">Verleih</a>
        <a href="equipment.html">Equipmentverwaltung</a>
        <a href="admin.html">Admin</a>
    </nav>
</header>

<main>
    <h2>Verleihübersicht</h2>

    <div style="margin-bottom: 20px;">
        <button onclick="openAddRentalModal()">➕ Neuen Verleih erfassen</button>
        <input type="text" id="search-rentals" placeholder="Verleihvorgänge suchen">
    </div>

    <table id="rental-table">
        <thead>
            <tr>
                <th>Mitglied</th>
                <th>Equipment</th>
                <th>Verleihdatum</th>
                <th>Rückgabedatum</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="rental-cards"></div>
</main>

<div id="user-info" style="text-align: center; padding: 10px;"></div>

<!-- Verleih Modal -->
<div class="modal" id="rentalModal" style="display:none;">
    <div class="modal-content">
        <h2 id="rental-modal-title">Neuen Verleih erfassen</h2>
        <form id="rental-form">
            <table style="width: 100%;">
                <tr><td>Mitglied suchen:</td><td><input type="text" id="member-search" placeholder="Mitglied suchen..."></td></tr>
                <tr><td>Mitglied auswählen:</td><td><select id="r-member" size="5" required></select></td></tr>
                <tr><td>Equipment:</td><td><input type="text" id="r-equipment" required></td></tr>
                <tr><td>Verleihdatum:</td><td><input type="date" id="r-date" required></td></tr>
                <tr><td>Rückgabedatum:</td><td><input type="date" id="r-return"></td></tr>
            </table>
            <input type="hidden" id="r-id">
            <br>
            <button type="submit">Speichern</button>
            <button type="button" onclick="closeRentalModal()">Abbrechen</button>
        </form>
    </div>
</div>

<script src="shared.js"></script>
<script>
checkLogin();

const user = getUserInfo();
if (user) {
    document.getElementById('user-info').innerHTML = `
        Angemeldet als <strong>${user.username}</strong> (${user.role})
        <button onclick="logout()" style="margin-left: 10px;">Logout</button>
    `;
}

function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
}

function toggleMenu() {
    document.getElementById('main-nav').classList.toggle('show');
}

function closeRentalModal() {
    document.getElementById('rentalModal').style.display = 'none';
}

function openAddRentalModal() {
    document.getElementById('rental-form').reset();
    document.getElementById('r-id').value = '';
    document.getElementById('rentalModal').style.display = 'flex';
}

const rentalData = [];
const apiMembers = 'https://tcs-manager-backend.onrender.com/api/members';
let members = [];

function loadActiveMembers() {
    fetch(apiMembers, {
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    })
    .then(res => res.json())
    .then(data => {
        members = data.filter(m => m.status === "aktiv" && m.ttu_gueltigkeit && new Date(m.ttu_gueltigkeit) >= new Date());
        populateMemberDropdown();
    });
}

function populateMemberDropdown() {
    const select = document.getElementById('r-member');
    select.innerHTML = '';

    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = `${member.vorname} ${member.name} (gültig bis ${member.ttu_gueltigkeit.substring(0,10)})`;
        select.appendChild(option);
    });
}

document.getElementById('member-search').addEventListener('input', function() {
    const search = this.value.toLowerCase();
    const options = document.querySelectorAll('#r-member option');

    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(search) ? '' : 'none';
    });
});

function renderRentalTable(data) {
    const tbody = document.querySelector('#rental-table tbody');
    const cardsContainer = document.querySelector('.rental-cards');
    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    data.forEach(rental => {
        const member = members.find(m => m.id == rental.memberId);
        const memberName = member ? `${member.vorname} ${member.name}` : rental.memberId;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${memberName}</td>
            <td>${rental.equipment}</td>
            <td>${rental.date}</td>
            <td>${rental.returnDate || '-'}</td>
            <td>${rental.status}</td>
            <td><button onclick='editRental(${JSON.stringify(rental)})'>Bearbeiten</button></td>
        `;
        tbody.appendChild(tr);

        const card = document.createElement('div');
        card.className = "member-card";
        card.innerHTML = `
            <h3>${memberName}</h3>
            <p>Equipment: ${rental.equipment}</p>
            <p>Verleihdatum: ${rental.date}</p>
            <p>Rückgabe: ${rental.returnDate || '-'}</p>
            <p>Status: ${rental.status}</p>
            <button onclick='editRental(${JSON.stringify(rental)})'>Bearbeiten</button>
        `;
        cardsContainer.appendChild(card);
    });
}

document.getElementById('rental-form').addEventListener('submit', (e) => {
    e.preventDefault();

    const rental = {
        memberId: document.getElementById('r-member').value,
        equipment: document.getElementById('r-equipment').value,
        date: document.getElementById('r-date').value,
        returnDate: document.getElementById('r-return').value,
        status: document.getElementById('r-return').value ? "Zurückgegeben" : "Verliehen"
    };

    rentalData.push(rental);
    closeRentalModal();
    renderRentalTable(rentalData);
});

function editRental(rental) {
    document.getElementById('r-id').value = rental.id || '';
    document.getElementById('r-member').value = rental.memberId;
    document.getElementById('r-equipment').value = rental.equipment;
    document.getElementById('r-date').value = rental.date;
    document.getElementById('r-return').value = rental.returnDate;
    document.getElementById('rentalModal').style.display = 'flex';
}

document.addEventListener('DOMContentLoaded', () => {
    loadActiveMembers();
    renderRentalTable(rentalData);
});
</script>

</body>
</html>
