<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verleih - Tauchclub Simbach am Inn</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="header-container">
        <div class="burger" onclick="toggleMenu()">â˜°</div>
        <h1>Verleih - Tauchclub Simbach am Inn</h1>
    </div>
    <nav id="main-nav">
        <a href="index.html">Start</a>
        <a href="mitgliederverwaltung.html">Mitgliederverwaltung</a>
        <a href="verleih.html">Verleih</a>
        <a href="equipment.html">Equipmentverwaltung</a>
        <a href="admin.html">Admin</a>
    </nav>
</header>

<main>
    <h2>VerleihÃ¼bersicht</h2>

    <div style="margin-bottom: 20px;">
        <button onclick="openAddRentalModal()">âž• Neuen Verleih erfassen</button>
        <input type="text" id="search-rentals" placeholder="VerleihvorgÃ¤nge suchen">
    </div>

    <table id="rental-table">
        <thead>
            <tr>
                <th>Mitglied</th>
                <th>Equipment</th>
                <th>Verleihdatum</th>
                <th>RÃ¼ckgabedatum</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="rental-cards"></div>
</main>

<div id="user-info" style="text-align: center; padding: 10px;"></div>

<!-- Verleih Modal -->
<div class="modal" id="rentalModal" style="display:none;">
    <div class="modal-content">
        <h2 id="rental-modal-title">Neuen Verleih erfassen</h2>
        <form id="rental-form">
            <table style="width: 100%;">
                <tr><td>Mitglied:</td><td>
                    <input type="text" id="r-member-search" placeholder="Mitglied suchen..." autocomplete="off" required>
                    <ul id="r-member-suggestions" class="autocomplete-suggestions"></ul>
                    <input type="hidden" id="r-member-id">
                </td></tr>
                <tr><td>Equipment:</td><td>
                    <input type="text" id="r-equipment-search" placeholder="Equipment suchen..." autocomplete="off" required>
                    <ul id="r-equipment-suggestions" class="autocomplete-suggestions"></ul>
                    <input type="hidden" id="r-equipment-id">
                </td></tr>
                <tr><td>Verleihdatum:</td><td><input type="date" id="r-date" required></td></tr>
            </table>
            <br>
            <button type="submit">Speichern</button>
            <button type="button" onclick="closeRentalModal()">Abbrechen</button>
        </form>
    </div>
</div>

<script src="shared.js"></script>
<script>
checkLogin();

const user = getUserInfo();
if (user) {
    document.getElementById('user-info').innerHTML = `
        Angemeldet als <strong>${user.username}</strong> (${user.role})
        <button onclick="logout()" style="margin-left: 10px;">Logout</button>
    `;
}

function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
}

function toggleMenu() {
    document.getElementById('main-nav').classList.toggle('show');
}

function closeRentalModal() {
    document.getElementById('rentalModal').style.display = 'none';
}

function openAddRentalModal() {
    document.getElementById('rental-form').reset();
    document.getElementById('rental-modal-title').innerText = "Neuen Verleih erfassen";
    const today = new Date().toISOString().substr(0, 10);
    document.getElementById('r-date').value = today;
    document.getElementById('rentalModal').style.display = 'flex';
}

const apiMembers = 'https://tcs-manager-backend.onrender.com/api/members';
const apiEquipment = 'https://tcs-manager-backend.onrender.com/api/equipment';
const apiRentals = 'https://tcs-manager-backend.onrender.com/api/rentals';

let members = [];
let equipmentList = [];
let allEquipmentList = [];

function loadActiveMembers() {
    return fetch(apiMembers, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
        .then(res => res.json())
        .then(data => {
            members = data.filter(m => m.status.toLowerCase() === "aktiv" && m.ttu_gueltigkeit && new Date(m.ttu_gueltigkeit) >= new Date());
        });
}

function loadAvailableEquipment() {
    return fetch(apiEquipment, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
        .then(res => res.json())
        .then(data => {
            equipmentList = data.filter(eq => eq.status === "Aktiv" && !eq.verliehen);
        });
}

function loadAllEquipment() {
    return fetch(apiEquipment, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
        .then(res => res.json())
        .then(data => {
            allEquipmentList = data;
        });
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toISOString().split('T')[0];
}

async function renderRentalTable() {
    const response = await fetch(apiRentals);
    const rentals = await response.json();

    const tbody = document.querySelector('#rental-table tbody');
    const cardsContainer = document.querySelector('.rental-cards');
    tbody.innerHTML = '';
    cardsContainer.innerHTML = '';

    rentals.forEach(rental => {
        const member = members.find(m => m.id == rental.member_id);
        const equipment = allEquipmentList.find(eq => eq.id == rental.equipment_id);
        const memberName = member ? `${member.vorname} ${member.name}` : rental.member_id;
        const equipmentName = equipment ? equipment.name : rental.equipment_id;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${memberName}</td>
            <td>${equipmentName}</td>
            <td>${formatDate(rental.rental_date)}</td>
            <td>${formatDate(rental.return_date)}</td>
            <td>${rental.status}</td>
            <td><button onclick='confirmReturn(${JSON.stringify(rental)})'><span style="font-size:18px;">ðŸšª</span></button></td>
        `;
        tbody.appendChild(tr);

        const card = document.createElement('div');
        card.className = "equipment-card";
        card.innerHTML = `
            <h3>${memberName}</h3>
            <p><strong>Equipment:</strong> ${equipmentName}</p>
            <p><strong>Verleihdatum:</strong> ${formatDate(rental.rental_date)}</p>
            <p><strong>Status:</strong> ${rental.status}</p>
            <button onclick='confirmReturn(${JSON.stringify(rental)})'><span style="font-size:18px;">ðŸšª</span></button>
        `;
        cardsContainer.appendChild(card);
    });
}

async function confirmReturn(rental) {
    const today = new Date().toISOString().split('T')[0];
    const confirmed = confirm(`RÃ¼ckgabe bestÃ¤tigen:\n\nMitglied: ${rental.member_id}\nEquipment: ${rental.equipment_id}\nDatum: ${today}`);

    if (confirmed) {
        await fetch(`${apiRentals}/${rental.id}/return`, { method: 'PUT' });
        await Promise.all([loadActiveMembers(), loadAllEquipment(), loadAvailableEquipment()]);
        renderRentalTable();
    }
}

document.getElementById('rental-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rental = {
        member_id: document.getElementById('r-member-id').value,
        equipment_id: document.getElementById('r-equipment-id').value,
        rental_date: document.getElementById('r-date').value,
    };

    await fetch(apiRentals, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rental)
    });

    closeRentalModal();
    await Promise.all([loadActiveMembers(), loadAllEquipment(), loadAvailableEquipment()]);
    renderRentalTable();
});

const memberSearchInput = document.getElementById('r-member-search');
const memberSuggestions = document.getElementById('r-member-suggestions');
const memberIdInput = document.getElementById('r-member-id');

memberSearchInput.addEventListener('input', () => {
    const search = memberSearchInput.value.toLowerCase();
    memberSuggestions.innerHTML = '';
    if (!search) return;

    const results = members.filter(member => (`${member.vorname} ${member.name}`).toLowerCase().includes(search)).slice(0, 3);
    if (results.length === 1) {
        memberSearchInput.value = `${results[0].vorname} ${results[0].name}`;
        memberIdInput.value = results[0].id;
    } else {
        results.forEach(member => {
            const li = document.createElement('li');
            li.textContent = `${member.vorname} ${member.name} (gÃ¼ltig bis ${member.ttu_gueltigkeit.substring(0, 10)})`;
            li.onclick = () => {
                memberSearchInput.value = `${member.vorname} ${member.name}`;
                memberIdInput.value = member.id;
                memberSuggestions.innerHTML = '';
            };
            memberSuggestions.appendChild(li);
        });
    }
});

const equipmentSearchInput = document.getElementById('r-equipment-search');
const equipmentSuggestions = document.getElementById('r-equipment-suggestions');
const equipmentIdInput = document.getElementById('r-equipment-id');

equipmentSearchInput.addEventListener('input', () => {
    const search = equipmentSearchInput.value.toLowerCase();
    equipmentSuggestions.innerHTML = '';
    if (!search) return;

    const results = equipmentList.filter(eq =>
        (eq.name && eq.name.toLowerCase().includes(search)) ||
        (eq.kategorie && eq.kategorie.toLowerCase().includes(search)) ||
        (eq.beschreibung && eq.beschreibung.toLowerCase().includes(search)) ||
        (eq.groesse && eq.groesse.toLowerCase().includes(search))
    ).slice(0, 3);

    if (results.length === 1) {
        equipmentSearchInput.value = results[0].name;
        equipmentIdInput.value = results[0].id;
    } else {
        results.forEach(eq => {
            const li = document.createElement('li');
            li.textContent = `${eq.name} (${eq.kategorie}, ${eq.beschreibung}, ${eq.groesse})`;
            li.onclick = () => {
                equipmentSearchInput.value = eq.name;
                equipmentIdInput.value = eq.id;
                equipmentSuggestions.innerHTML = '';
            };
            equipmentSuggestions.appendChild(li);
        });
    }
});

document.addEventListener('DOMContentLoaded', () => {
    Promise.all([
        loadActiveMembers(),
        loadAllEquipment(),
        loadAvailableEquipment()
    ]).then(() => {
        renderRentalTable();
    });
});
</script>

<style>
.autocomplete-suggestions {
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    background: white;
    list-style: none;
    padding: 0;
    margin: 0;
    position: absolute;
    z-index: 1000;
    width: 85%;
}

.autocomplete-suggestions li {
    padding: 8px;
    cursor: pointer;
    display: flex;
    gap: 10px;
    align-items: center;
}

.autocomplete-suggestions li:hover {
    background: #eee;
}

@media (max-width: 600px) {
    #rental-table {
        display: none;
    }
    .rental-cards {
        display: block;
    }
}

@media (min-width: 601px) {
    .rental-cards {
        display: none;
    }
}
</style>

</body>
</html>
